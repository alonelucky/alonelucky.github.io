{
    "version": "https://jsonfeed.org/version/1",
    "title": "小码农博客 • All posts by \"测试\" tag",
    "description": null,
    "home_page_url": "http://qiubo.ink",
    "items": [
        {
            "id": "http://qiubo.ink/2023/08/30/%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8wrk%E8%BF%9B%E8%A1%8C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/",
            "url": "http://qiubo.ink/2023/08/30/%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8wrk%E8%BF%9B%E8%A1%8C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95/",
            "title": "学习使用wrk进行压力测试",
            "date_published": "2023-08-30T13:13:08.000Z",
            "content_html": "<p>最近发现了一个新的 HTTP 压力测试工具 <code>wrk</code>，非常容易上手和使用。<code>wrk</code> 使用非常简单，对应的命令行参数也不多，但是足够自己简单压测一些 <code>http</code> 服务了。官方下载地址为 <code>https://github.com/wg/wrk</code>。</p>\n<span id=\"more\"></span>\n\n<p><img src=\"/images/2023-08-30/01.png\"></p>\n<p>根据官方示例，其实 <code>wrk</code> 最大的特点是支持动态脚本修改请求，本身不大的身体集成了 <code>luajit</code> 用于实施请求时动态修改请求&#x2F;响应。</p>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><h5 id=\"Windows\"><a href=\"#Windows\" class=\"headerlink\" title=\"Windows\"></a>Windows</h5><p>由于wrk依赖的一些特性在Windows上没有，因此<a href=\"https://github.com/wg/wrk/issues/187\">不支持</a>在windows上编译运行，编译成功也会有一些奇怪的问题。因此建议曲线使用，在 docker 中编译, 借助docker在windows上使用。</p>\n<h5 id=\"MacOS\"><a href=\"#MacOS\" class=\"headerlink\" title=\"MacOS\"></a>MacOS</h5><ol>\n<li><code>brew install wrk</code></li>\n<li>源码安装<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 拉取源码</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/wg/wrk</span><br><span class=\"line\"><span class=\"comment\"># mbp2018 大概编译10分钟</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> wrk &amp;&amp; make</span><br><span class=\"line\"><span class=\"comment\"># 运行</span></span><br><span class=\"line\">wrk -h</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h5 id=\"Linux\"><a href=\"#Linux\" class=\"headerlink\" title=\"Linux\"></a>Linux</h5><p>源码安装</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 拉取源码</span></span><br><span class=\"line\">git <span class=\"built_in\">clone</span> https://github.com/wg/wrk</span><br><span class=\"line\"><span class=\"comment\"># 编译过程相关依赖可以参照 dockerfile 中的依赖项</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> wrk &amp;&amp; make</span><br><span class=\"line\"><span class=\"comment\"># 运行</span></span><br><span class=\"line\">wrk -h</span><br></pre></td></tr></table></figure>\n<h5 id=\"Docker安装\"><a href=\"#Docker安装\" class=\"headerlink\" title=\"Docker安装\"></a>Docker安装</h5><p>Dockerfile内容如下，较少的依赖，编译后无依赖项</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> ubuntu:latest as BUILD</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> root</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"language-bash\"> ./ /root/wrk</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> <span class=\"built_in\">cd</span> wrk &amp;&amp; apt update &amp;&amp; apt install make gcc unzip openssl libterm-readkey-perl -y </span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> make</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> ubuntu:latest</span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> --from=BUILD /root/wrk/wrk /usr/local/bin</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用介绍\"><a href=\"#使用介绍\" class=\"headerlink\" title=\"使用介绍\"></a>使用介绍</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wrk: invalid option -- h</span><br><span class=\"line\">Usage: wrk &lt;options&gt; &lt;url&gt;                            </span><br><span class=\"line\">  Options:                                            </span><br><span class=\"line\">    -c, --connections &lt;N&gt;  Connections to keep open   # 总连接数(客户端数)</span><br><span class=\"line\">    -d, --duration    &lt;T&gt;  Duration of test           # 测试运行总时间</span><br><span class=\"line\">    -t, --threads     &lt;N&gt;  Number of threads to use   # 线程数</span><br><span class=\"line\">                                                      </span><br><span class=\"line\">    -s, --script      &lt;S&gt;  Load Lua script file       # 执行脚本 </span><br><span class=\"line\">    -H, --header      &lt;H&gt;  Add header to request      # 全局请求 header</span><br><span class=\"line\">        --latency          Print latency statistics   # 输出延迟统计信息</span><br><span class=\"line\">        --timeout     &lt;T&gt;  Socket/request timeout     # 单次请求超时时间</span><br><span class=\"line\">    -v, --version          Print version details      # 版本</span><br><span class=\"line\">                                                      </span><br><span class=\"line\">  Numeric arguments may include a SI unit (1k, 1M, 1G) # 数值参数可以包括单位(1K、1M、1G)</span><br><span class=\"line\">  Time arguments may include a time unit (2s, 2m, 2h)  # 时间参数可以包括时间单位(2s、2m、2h)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h3><p>使用 <code>nodejs</code> 写了一个脚本, 用于测试并发</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">const</span> <span class=\"variable\">http</span> <span class=\"operator\">=</span> require(<span class=\"string\">&#x27;http&#x27;</span>);</span><br><span class=\"line\"><span class=\"type\">const</span> <span class=\"variable\">port</span> <span class=\"operator\">=</span> Number(process.argv[<span class=\"number\">2</span>]) || <span class=\"number\">0</span>;</span><br><span class=\"line\">console.log(port);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">let</span> <span class=\"variable\">count</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">http.createServer((req, res) =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (req.url.includes(<span class=\"string\">&#x27;status&#x27;</span>)) <span class=\"keyword\">return</span> res.end();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (req.url.includes(<span class=\"string\">&#x27;count&#x27;</span>)) &#123; <span class=\"comment\">// 可以事后统计实际处理的请求数量</span></span><br><span class=\"line\">        res.write(`hello $&#123;count&#125;`);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> res.end();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"type\">let</span> <span class=\"variable\">closed</span> <span class=\"operator\">=</span> <span class=\"literal\">false</span>; <span class=\"comment\">// 记录请求被取消</span></span><br><span class=\"line\">    req.on(<span class=\"string\">&#x27;close&#x27;</span>, () =&gt; &#123;</span><br><span class=\"line\">        closed = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">    setTimeout(() =&gt; &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (closed) &#123;</span><br><span class=\"line\">            console.log(<span class=\"string\">&#x27;req cancel&#x27;</span>); <span class=\"comment\">// 最终停止时可能有部分请求被强制取消，作为记录</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> res.end();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        res.write(`hello $&#123;port&#125;`);</span><br><span class=\"line\">        res.statusCode = <span class=\"number\">200</span>;</span><br><span class=\"line\">        res.end();</span><br><span class=\"line\">        count++; <span class=\"comment\">// 计数</span></span><br><span class=\"line\">    &#125;, Math.random() * <span class=\"number\">1000</span>) <span class=\"comment\">// 模拟响应处理延迟</span></span><br><span class=\"line\">&#125;).listen(port, () =&gt; &#123;</span><br><span class=\"line\">    console.log(`server is running at $&#123;port&#125;`);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n<p>使用 <code>pm2</code> 进程管理启动集群服务，多进程方式处理响应</p>\n<p>动态请求脚本内容如下</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">counter = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">request</span><span class=\"params\">()</span></span></span><br><span class=\"line\">    <span class=\"built_in\">path</span> = <span class=\"string\">&quot;/&quot;</span> .. counter</span><br><span class=\"line\">    wrk.headers[<span class=\"string\">&quot;X-Counter&quot;</span>] = counter # 为每次请求头增加叠加数字</span><br><span class=\"line\">    counter = counter + <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> wrk.<span class=\"built_in\">format</span>(<span class=\"literal\">nil</span>, <span class=\"built_in\">path</span>)</span><br><span class=\"line\"><span class=\"keyword\">end</span></span><br></pre></td></tr></table></figure>\n\n<p>请求示例如下:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ wrk -c 5 -t 5 -s 1280.lua --latency http://127.0.0.1:1280/</span><br><span class=\"line\"></span><br><span class=\"line\">Running 10s test @ http://127.0.0.1:1280/   # 默认执行10s</span><br><span class=\"line\">  5 threads and 5 connections               # 5个线程，一共5个客户端, 平均一个线程作为一个客户端 </span><br><span class=\"line\">  Thread Stats   Avg      Stdev     Max     +/- Stdev </span><br><span class=\"line\">                (平均值)  (标准差)   (最大值)  (正负一个标准差所占比例)</span><br><span class=\"line\">    Latency   531.20ms  284.56ms   1.01s    59.34%  (延迟)[主要关注]</span><br><span class=\"line\">    Req/Sec     2.44      2.57     10.00    91.95%  (每秒处理中的请求数)</span><br><span class=\"line\">  Latency Distribution  (延迟分布)</span><br><span class=\"line\">     50%  576.00ms      # 50%以内的请求</span><br><span class=\"line\">     75%  777.17ms      # 75%以内的请求</span><br><span class=\"line\">     90%  914.97ms      # 90%以内的请求</span><br><span class=\"line\">     99%    1.01s       # 99%以内的请求</span><br><span class=\"line\">  91 requests in 10.02s, 13.95KB read   (10s之内共处理完成了91个请求，读取了13.95KB数据)</span><br><span class=\"line\">Requests/sec:      9.09     (平均每秒262.22个请求)</span><br><span class=\"line\">Transfer/sec:      1.39KB   (平均每秒读取数据554.27KB)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"参考文章\"><a href=\"#参考文章\" class=\"headerlink\" title=\"参考文章\"></a>参考文章</h3><ol>\n<li><code>https://www.escapelife.site/posts/4b014d0b.html</code></li>\n<li><code>https://corvo.myseu.cn/2021/03/24/2021-03-24-使用wrk压测并精细控制并发请求量/</code></li>\n<li><code>http://www.taodudu.cc/news/show-5177501.html?action=onClick</code></li>\n</ol>\n",
            "tags": [
                "测试",
                "lua",
                "wrk"
            ]
        },
        {
            "id": "http://qiubo.ink/2020/03/26/docker%E5%85%8D%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE/",
            "url": "http://qiubo.ink/2020/03/26/docker%E5%85%8D%E5%88%A0%E9%99%A4%E5%AE%B9%E5%99%A8%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE/",
            "title": "docker免删除容器修改配置",
            "date_published": "2020-03-26T21:28:24.000Z",
            "content_html": "<p>适用于小服务, 原理是暂停docker服务来修改容器配置,然后启动</p>\n<span id=\"more\"></span>\n<h3 id=\"起因docker部署mysql时端口配置错误\"><a href=\"#起因docker部署mysql时端口配置错误\" class=\"headerlink\" title=\"起因docker部署mysql时端口配置错误\"></a>起因docker部署mysql时端口配置错误</h3><p>3307 -&gt; 3307</p>\n<h3 id=\"知道可以删除运行中的docker容器-然后重启\"><a href=\"#知道可以删除运行中的docker容器-然后重启\" class=\"headerlink\" title=\"知道可以删除运行中的docker容器,然后重启\"></a>知道可以删除运行中的docker容器,然后重启</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker stop mysql_name &amp;&amp; docker <span class=\"built_in\">rm</span> mysql_name</span><br></pre></td></tr></table></figure>\n<h3 id=\"增加一种方式-暂停docker服务-修改hostconfig-json文件-再启动\"><a href=\"#增加一种方式-暂停docker服务-修改hostconfig-json文件-再启动\" class=\"headerlink\" title=\"增加一种方式, 暂停docker服务, 修改hostconfig.json文件,再启动\"></a>增加一种方式, 暂停docker服务, 修改hostconfig.json文件,再启动</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 暂停服务</span></span><br><span class=\"line\">service docker stop</span><br><span class=\"line\"><span class=\"comment\"># 修改hostcaonfig.json</span></span><br><span class=\"line\">vim /var/lib/docker/containers/[cont_hash_code]/hostconfig.json</span><br><span class=\"line\"><span class=\"comment\"># 修改对应配置,保存,启动docker</span></span><br><span class=\"line\">service docker start</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "测试",
                "docker"
            ]
        },
        {
            "id": "http://qiubo.ink/2019/06/27/Golang%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%8F%8A%E6%B5%8B%E8%AF%95%E8%A6%86%E7%9B%96%E7%8E%87/",
            "url": "http://qiubo.ink/2019/06/27/Golang%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E5%8F%8A%E6%B5%8B%E8%AF%95%E8%A6%86%E7%9B%96%E7%8E%87/",
            "title": "Golang单元测试及测试覆盖率",
            "date_published": "2019-06-27T09:21:24.000Z",
            "content_html": "<p>使用 Golang 内置库 <code>testing</code> 测试书写的代码,如有不足,请雅正.</p>\n<span id=\"more\"></span>\n<p>本文 go 版本 1.12.5, 在 <code>go mod</code> 下 当前项目名称 <code>goshop</code></p>\n<h3 id=\"1-书写代码\"><a href=\"#1-书写代码\" class=\"headerlink\" title=\"1. 书写代码\"></a>1. 书写代码</h3><ol>\n<li>自定义库代码 <code>goshop/app/lib</code> 下 utils.go  <figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> tools</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// CheckPhoneNumber 校验手机号</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">CheckPhoneNumber</span><span class=\"params\">(phone <span class=\"type\">string</span>)</span></span> <span class=\"type\">bool</span> &#123;</span><br><span class=\"line\">  <span class=\"comment\">// 手机号长度11位</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> StringLength(phone) != <span class=\"number\">11</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  reg := regexp.MustCompile(<span class=\"string\">`^1[3,4,5,6,7,8,9]&#123;1&#125;[0-9]&#123;9&#125;$`</span>)</span><br><span class=\"line\">  <span class=\"keyword\">return</span> reg.MatchString(phone)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// StringLength 获取字符串长度</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">StringLength</span><span class=\"params\">(str <span class=\"type\">string</span>)</span></span> <span class=\"type\">int</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">return</span> strings.Count(str, <span class=\"string\">&quot;&quot;</span>) - <span class=\"number\">1</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n<li>测试代码 <code>goshop/app/lib</code> 下 utils_test.go  <figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> tools</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> (</span><br><span class=\"line\">  <span class=\"string\">&quot;testing&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">TestCheckPhoneNumber</span><span class=\"params\">(t *testing.T)</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">type</span> suite <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    data   <span class=\"type\">string</span></span><br><span class=\"line\">    result <span class=\"type\">bool</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  phoneExample := []suite&#123;</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;&quot;</span>, <span class=\"literal\">false</span>&#125;,</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;12345678901&quot;</span>, <span class=\"literal\">false</span>&#125;,</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;1020&quot;</span>, <span class=\"literal\">false</span>&#125;,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;19456782901&quot;</span>, <span class=\"literal\">true</span>&#125;,</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> _, v := <span class=\"keyword\">range</span> phoneExample &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> result := CheckPhoneNumber(v.data); result != v.result &#123;</span><br><span class=\"line\">      t.Errorf(<span class=\"string\">&quot;测试用例 %s : 测试结构 %t , 与期望不符合 %t&quot;</span>, v.data, result, v.result)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">TestStringLength</span><span class=\"params\">(t *testing.T)</span></span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">type</span> suite <span class=\"keyword\">struct</span> &#123;</span><br><span class=\"line\">    data   <span class=\"type\">string</span></span><br><span class=\"line\">    result <span class=\"type\">int</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  strExample := []suite&#123;</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;1&quot;</span>, <span class=\"number\">1</span>&#125;,</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;&quot;</span>, <span class=\"number\">0</span>&#125;,</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;1678&quot;</span>, <span class=\"number\">4</span>&#125;,</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;13456789301&quot;</span>, <span class=\"number\">11</span>&#125;,</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;abcd&quot;</span>, <span class=\"number\">4</span>&#125;,</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;hello world&quot;</span>, <span class=\"number\">11</span>&#125;,</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;我在这&quot;</span>, <span class=\"number\">3</span>&#125;,</span><br><span class=\"line\">    suite&#123;<span class=\"string\">&quot;你是谁?Who are you?&quot;</span>, <span class=\"number\">16</span>&#125;,</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">for</span> _, v := <span class=\"keyword\">range</span> strExample &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> result := StringLength(v.data); result != v.result &#123;</span><br><span class=\"line\">      t.Errorf(<span class=\"string\">&quot;测试用例 %s : 测试结构 %d , 与期望不符合 %d&quot;</span>, v.data, result, v.result)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"2-查看覆盖率\"><a href=\"#2-查看覆盖率\" class=\"headerlink\" title=\"2. 查看覆盖率\"></a>2. 查看覆盖率</h3><blockquote>\n<p><code>go test</code> 常用命令解释<br> 用法 <code>go test [build/_test flags] [packages] [build/test flags &amp; test binary flags]</code><br> <code>go test [file.go / mod_dir | main_test.go]</code> &#x2F; <code>go test 文件名/包名(main_test.go)</code></p>\n</blockquote>\n<ol>\n<li><p>普通展示<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 普通测试,只展示测试结果及时间</span></span><br><span class=\"line\">➜  go test goshop/app/lib</span><br><span class=\"line\"><span class=\"comment\">// ok      goshop/app/lib  0.007s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// 展示测试明细, 此时仍没有覆盖率</span></span><br><span class=\"line\">➜  go test goshop/app/lib -v</span><br><span class=\"line\"><span class=\"comment\">// === RUN   TestCheckEmail</span></span><br><span class=\"line\"><span class=\"comment\">// --- PASS: TestCheckEmail (0.00s)</span></span><br><span class=\"line\"><span class=\"comment\">// === RUN   TestStringLength</span></span><br><span class=\"line\"><span class=\"comment\">// --- PASS: TestStringLength (0.00s)</span></span><br><span class=\"line\"><span class=\"comment\">// === RUN   TestCheckPhoneNumber</span></span><br><span class=\"line\"><span class=\"comment\">// --- PASS: TestCheckPhoneNumber (0.00s)</span></span><br><span class=\"line\"><span class=\"comment\">// PASS</span></span><br><span class=\"line\"><span class=\"comment\">// ok      goshop/app/lib  (cached)</span></span><br></pre></td></tr></table></figure></p>\n</li>\n<li><p>展示测试明细及覆盖率,<br>展示的是当前库的所有文件的覆盖率,<br>此时已经知道覆盖率了,<br>但是不知道测试到底覆盖的是哪部分代码,<br>哪部分没有覆盖<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ go test goshop/app/lib -v -covermode=count </span><br><span class=\"line\"><span class=\"comment\">// === RUN   TestCheckEmail</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\"><span class=\"comment\">// PASS</span></span><br><span class=\"line\"><span class=\"comment\">// coverage: 19.2% of statements</span></span><br><span class=\"line\"><span class=\"comment\">// ok      goshop/app/lib  0.007s  coverage: 19.2% of statements</span></span><br></pre></td></tr></table></figure></p>\n</li>\n<li><p>展示测试覆盖率,并生成覆盖统计文件到 count.out,<br>count.out 文件中详细展示了每个文件测试时某一行,执行的次数及其他信息(暂时只能用到次数)</p>\n</li>\n</ol>\n<pre><code><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ go test goshop/app/lib -v -coverprofile=count.<span class=\"property\">out</span></span><br><span class=\"line\"><span class=\"comment\">// === RUN   TestCheckEmail</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\"><span class=\"comment\">// PASS</span></span><br><span class=\"line\"><span class=\"comment\">// coverage: 19.2% of statements</span></span><br><span class=\"line\"><span class=\"comment\">// ok      goshop/app/lib  0.007s  coverage: 19.2% of statements</span></span><br></pre></td></tr></table></figure>\n</code></pre>\n<ol start=\"4\">\n<li>分析 count.out 文件生成想要的结果<br>-func 生成每个函数的覆盖率<br>-html 生成 html 文件,已图形形式展示每个函数,每一行代码的覆盖率<br>生成测试运行,函数覆盖率,展示每一个函数单元测试的覆盖率,100% 则测试完整,0 则没有测试<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ go tool cover -func=count.<span class=\"property\">out</span></span><br><span class=\"line\"><span class=\"comment\">// goshop/app/lib/jwt.go:31:       signHeader              0.0%</span></span><br><span class=\"line\"><span class=\"comment\">// ....</span></span><br><span class=\"line\"><span class=\"comment\">// goshop/app/lib/utils.go:11:     CheckEmail              100.0%</span></span><br><span class=\"line\"><span class=\"comment\">// goshop/app/lib/utils.go:21:     CheckPhoneNumber        100.0%</span></span><br><span class=\"line\"><span class=\"comment\">// ...</span></span><br><span class=\"line\"><span class=\"comment\">// total:                          (statements)            19.2%</span></span><br></pre></td></tr></table></figure></li>\n</ol>\n<pre><code>`➜ go tool cover -html=count.out` 会打开默认浏览器,展示测试覆盖率的图形化,\n可以切换,当前库下每个文件,看到每一行代码是否测试执行,没有执行的显示为红色, 灰色是不需要测试的, 亮绿色是测试通过的\n![](go-tool-cover-html.png)\n</code></pre>\n",
            "tags": [
                "golang",
                "测试"
            ]
        }
    ]
}